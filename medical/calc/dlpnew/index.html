<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор дозы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <!-- PWA Settings for iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dose Calc">

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Icons (Embedded SVG via Base64) -->
  <!-- Icon Description: Dark background with 4 blue/cyan rounded squares mimicking a calculator -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzBiMTAyMCIvPjxyZWN0IHg9IjExMCIgeT0iMTEwIiB3aWR0aD0iMTI1IiBoZWlnaHQ9IjEyNSIgcng9IjMyIiBmaWxsPSIzYjgyZjYiLz48cmVjdCB4PSIyNzYiIHk9IjExMCIgd2lkdGg9IjEyNSIgaGVpZ2h0PSIxMjUiIHJ4PSIzMiIgZmlsbD0iIzIyZDNlZSIvPjxyZWN0IHg9IjExMCIgeT0iMjc2IiB3aWR0aD0iMTI1IiBoZWlnaHQ9IjEyNSIgcng9IjMyIiBmaWxsPSIjMjJkM2VlIi8+PHJlY3QgeD0iMjc2IiB5PSIyNzYiIHdpZHRoPSIxMjUiIGhlaWdodD0iMTI1IiByeD0iMzIiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4=">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzBiMTAyMCIvPjxyZWN0IHg9IjExMCIgeT0iMTEwIiB3aWR0aD0iMTI1IiBoZWlnaHQ9IjEyNSIgcng9IjMyIiBmaWxsPSIzYjgyZjYiLz48cmVjdCB4PSIyNzYiIHk9IjExMCIgd2lkdGg9IjEyNSIgaGVpZ2h0PSIxMjUiIHJ4PSIzMiIgZmlsbD0iIzIyZDNlZSIvPjxyZWN0IHg9IjExMCIgeT0iMjc2IiB3aWR0aD0iMTI1IiBoZWlnaHQ9IjEyNSIgcng9IjMyIiBmaWxsPSIjMjJkM2VlIi8+PHJlY3QgeD0iMjc2IiB5PSIyNzYiIHdpZHRoPSIxMjUiIGhlaWdodD0iMTI1IiByeD0iMzIiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4=">

  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0b1020;
      --accent: #7dd3fc;
      --accent-soft: rgba(125, 211, 252, 0.1);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --error: #f97373;
      --radius-xl: 18px;
      --radius-lg: 12px;
      --shadow-soft: 0 30px 80px rgba(15, 23, 42, 0.8);
      
      /* Timer specific */
      --timer-bg: rgba(30, 41, 59, 0.6);
      --timer-bar-bg: rgba(148, 163, 184, 0.2);
    }

    * {
      box-sizing: border-box;
      /* Отключаем стандартное выделение при касании на мобильных */
      -webkit-tap-highlight-color: transparent;
    }

    /* Глобальное применение шрифта Inter */
    body, button, input, select, textarea {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #1e293b 0, transparent 55%),
        radial-gradient(circle at bottom right, #0f172a 0, transparent 55%),
        var(--bg);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
      /* Исправление скролла на iOS в PWA режиме */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .shell {
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at top, rgba(125, 211, 252, 0.08), transparent 60%),
                  linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      border-radius: 32px;
      padding: 1px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 0%, rgba(56, 189, 248, 0.08), transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(96, 165, 250, 0.07), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.85;
      pointer-events: none;
    }

    .panel {
      position: relative;
      z-index: 1;
      border-radius: 30px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
      padding: 26px 22px 22px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(16px);
    }

    @media (min-width: 640px) {
      .panel {
        padding: 26px 26px 24px;
      }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    .title-block {
      width: 100%;
    }

    h1 {
      font-size: 24px;
      letter-spacing: 0.03em;
      margin: 0 0 4px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 420px;
      line-height: 1.4;
    }

    main {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 720px) {
      main {
        grid-template-columns: 3fr 2fr;
        gap: 18px;
      }
    }

    .card {
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 16px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(125, 211, 252, 0.04), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 15px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
      font-weight: 500;
    }

    .card-body {
      position: relative;
      z-index: 1;
      display: grid;
      gap: 10px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.8;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 10px 12px; /* Чуть больше паддинг для тача */
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
      color: var(--text-main);
      font-size: 16px;
      outline: none;
      transition: border-color 160ms ease, box-shadow 160ms ease, background 160ms ease;
      appearance: none;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(125, 211, 252, 0.5);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
    }

    .select-wrap {
      position: relative;
    }

    .select-wrap::after {
      content: "▾";
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .field-inline {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .field-inline span.unit {
      font-size: 13px;
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
      white-space: nowrap;
    }

    .controls-row {
      display: flex;
      gap: 12px;
      margin-top: 6px;
      width: 100%;
    }

    .controls-row button {
      flex: 1;
      justify-content: center;
      padding: 12px 14px; /* Кнопки еще выше для пальца */
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px; /* Чуть крупнее текст кнопок */
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, background 160ms ease, color 160ms ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22d3ee, #3b82f6);
      color: #0b1120;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.55);
      font-weight: 500;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.55);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .btn-ghost:active {
      background: rgba(30, 64, 175, 0.4);
    }

    .result-main {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .result-label {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .result-value {
      display: flex;
      align-items: baseline;
      gap: 8px;
      font-variant-numeric: tabular-nums;
    }

    .result-number {
      font-size: 28px;
      font-weight: 500;
    }

    .result-unit {
      font-size: 13px;
      color: var(--text-muted);
    }

    .result-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
    }

    .error {
      margin-top: 8px;
      font-size: 12px;
      color: var(--error);
      min-height: 16px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    /* Timer Styles */
    .timer-section {
      margin-top: 24px;
      padding-top: 18px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .timer-btn {
      width: 64px;
      background: rgba(34, 211, 238, 0.15);
      color: #7dd3fc;
      border: 1px solid rgba(125, 211, 252, 0.3);
      font-weight: 500;
      font-size: 13px;
      padding: 0;
      height: 36px;
    }
    
    .timer-btn.active {
      background: rgba(249, 115, 115, 0.15);
      color: #fca5a5;
      border-color: rgba(249, 115, 115, 0.3);
    }
    
    /* Анимация мигания кнопки */
    @keyframes flash-alert {
      0%, 100% {
        background-color: rgba(249, 115, 115, 0.15);
        color: #fca5a5;
        border-color: rgba(249, 115, 115, 0.3);
        box-shadow: none;
      }
      50% {
        background-color: #ef4444;
        color: #ffffff;
        border-color: #ef4444;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
      }
    }

    .timer-btn.finished {
      animation: flash-alert 0.3s ease-in-out 10;
    }

    .timer-track {
      flex: 1;
      height: 6px;
      background: var(--timer-bar-bg);
      border-radius: 99px;
      overflow: hidden;
      position: relative;
    }

    .timer-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%; 
      background: linear-gradient(90deg, #3b82f6, #22d3ee);
      border-radius: 99px;
      transition: width 1s linear;
    }

    .timer-display {
      font-size: 14px;
      font-variant-numeric: tabular-nums;
      color: var(--text-main);
      font-weight: 600;
      min-width: 42px;
      text-align: right;
    }

    select option {
      background-color: #020617;
      color: #e5e7eb;
    }

    select option:hover,
    select option:focus {
      background-color: #1d4ed8;
      color: #f9fafb;
    }

    select option:checked {
      background-color: #1d4ed8;
      color: #f9fafb;
    }

    @media (min-width: 1024px) {
      body {
        padding: 48px 24px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="panel">
      <header>
        <div class="title-block">
          <h1>Эффективная доза</h1>
          <div class="subtitle">
            Быстрый расчёт эффективной дозы КТ по DLP для взрослых пациентов.
          </div>
        </div>
      </header>

      <main>
        <section class="card">
          <h2>Ввод данных</h2>
          <div class="card-body">
            <div class="field">
              <div class="field-label-row">
                <label for="dlp">Поглощённая доза (DLP)</label>
                <span class="field-hint">Произведение дозы на длину</span>
              </div>
              <div class="field-inline">
                <input
                  id="dlp"
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9,.]*"
                  placeholder="Например, 750"
                >
                <span class="unit">мГр·см</span>
              </div>
            </div>

            <div class="field">
              <div class="field-label-row">
                <label for="region">Область исследования</label>
                <span class="field-hint">Коэффициенты для взрослых пациентов</span>
              </div>
              <div class="select-wrap">
                <select id="region">
                  <option value="head16">Голова · 16 см фантом</option>
                  <option value="neck16">Шея · 16 см фантом</option>
                  <option value="headneck16">Голова/шея · 16 см фантом</option>
                  <option value="chest32">Грудная клетка · 32 см фантом</option>
                  <option value="abdomen32">Брюшная полость · 32 см фантом</option>
                  <option value="legs32">Нижние конечности · 32 см фантом</option>
                </select>
              </div>
            </div>

            <div class="controls-row">
              <button class="btn-primary" id="calcBtn">
                Рассчитать
              </button>
              <button class="btn-ghost" id="resetBtn" type="button">
                Очистить
              </button>
            </div>

            <div class="error" id="error"></div>
          </div>
        </section>

        <section class="card">
          <h2>Результат</h2>
          <div class="card-body">
            <div class="result-main">
              <span class="result-label">Эффективная доза (E)</span>
              <div class="result-value">
                <span class="result-number" id="eValue">—</span>
                <span class="result-unit">мЗв</span>
              </div>
            </div>

            <div class="result-meta">
              <span class="pill" id="metaDlp">DLP: —</span>
              <span class="pill" id="metaCoeff">k: —</span>
              <span class="pill">Пациент: взрослый</span>
            </div>

            <div class="footer-note">
              Расчёт выполняется по формуле E = DLP × k, где k — дозовый коэффициент
              для выбранной области и фантома (взрослые пациенты, мЗв/(мГр·см)). [file:1]
            </div>
          </div>
        </section>
      </main>
      
      <!-- Timer Section -->
      <div class="timer-section">
        <button id="timerBtn" class="timer-btn">Старт</button>
        <div class="timer-track">
          <div id="timerFill" class="timer-fill" style="width: 100%;"></div>
        </div>
        <div id="timerDisplay" class="timer-display">02:00</div>
      </div>

    </div>
  </div>

    <script>
    const coeffs = {
      head16: 0.0014,      // Голова, 16 см
      neck16: 0.0060,      // Шея, 16 см
      headneck16: 0.0025,  // Голова/шея, 16 см
      chest32: 0.012,      // Грудная клетка, 32 см
      abdomen32: 0.014,    // Брюшная полость, 32 см
      legs32: 0.00020      // Нижние конечности, 32 см
    }; 

    const dlpInput = document.getElementById('dlp');
    const regionSelect = document.getElementById('region');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const errorBox = document.getElementById('error');

    const eValue = document.getElementById('eValue');
    const metaDlp = document.getElementById('metaDlp');
    const metaCoeff = document.getElementById('metaCoeff');

    // Timer Elements
    const timerBtn = document.getElementById('timerBtn');
    const timerFill = document.getElementById('timerFill');
    const timerDisplay = document.getElementById('timerDisplay');
    
    let timerInterval = null;
    let isTimerRunning = false;
    const TIMER_DURATION = 120; // 2 minutes in seconds
    let timeRemaining = TIMER_DURATION;

    function formatNumber(value, digits = 3) {
      if (!isFinite(value)) return '—';
      if (value === 0) return '0';
      if (value < 0.01) {
        return value.toExponential(2).replace(/e\+?/, '×10^');
      }
      return Number(value.toFixed(digits)).toString();
    }

    function calculate() {
      errorBox.textContent = '';

      const rawDlp = dlpInput.value.trim().replace(',', '.');
      const dlp = parseFloat(rawDlp);
      if (rawDlp === '' || isNaN(dlp) || dlp < 0) {
        errorBox.textContent = 'Введите неотрицательное числовое значение DLP.';
        eValue.textContent = '—';
        metaDlp.textContent = 'DLP: —';
        metaCoeff.textContent = 'k: —';
        return;
      }

      const region = regionSelect.value;
      const k = coeffs[region];
      if (typeof k !== 'number') {
        errorBox.textContent = 'Не удалось определить коэффициент для этой области.';
        return;
      }

      const e = dlp * k;

      eValue.textContent = formatNumber(e, 3);
      metaDlp.textContent = `DLP: ${formatNumber(dlp, 2)} мГр·см`;
      metaCoeff.textContent = `k: ${k} мЗв/(мГр·см)`;
    }

    function resetAll() {
      dlpInput.value = '';
      errorBox.textContent = '';
      eValue.textContent = '—';
      metaDlp.textContent = 'DLP: —';
      metaCoeff.textContent = 'k: —';
      regionSelect.selectedIndex = 0;
      dlpInput.focus();
    }

    // Timer Logic
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function updateTimerUI() {
      timerDisplay.textContent = formatTime(timeRemaining);
      const percent = (timeRemaining / TIMER_DURATION) * 100;
      timerFill.style.width = `${percent}%`;
    }

    function stopTimer() {
      clearInterval(timerInterval);
      isTimerRunning = false;
      timerBtn.textContent = 'Старт';
      timerBtn.classList.remove('active');
      timerBtn.classList.remove('finished');
      
      // Reset to full
      timeRemaining = TIMER_DURATION;
      updateTimerUI();
    }
    
    function timerFinished() {
      clearInterval(timerInterval);
      isTimerRunning = false;
      timerDisplay.textContent = "00:00";
      timerFill.style.width = "0%";
      
      // Попытка вибрации (Android only)
      if (navigator.vibrate) {
        navigator.vibrate([500, 200, 500]);
      }

      // Запускаем визуальный алерт
      timerBtn.classList.add('finished');
      timerBtn.textContent = '00:00';
      
      // Ждем окончания анимации (3 сек) и сбрасываем
      setTimeout(() => {
        stopTimer();
      }, 3000);
    }

    function startTimer() {
      if (isTimerRunning) {
        stopTimer();
        return;
      }

      isTimerRunning = true;
      timerBtn.textContent = 'Стоп';
      timerBtn.classList.add('active');
      timerBtn.classList.remove('finished');
      
      // Immediate update
      updateTimerUI();

      timerInterval = setInterval(() => {
        timeRemaining--;
        if (timeRemaining < 0) {
          timerFinished();
          return;
        }
        updateTimerUI();
      }, 1000);
    }

    calcBtn.addEventListener('click', function (e) {
      e.preventDefault();
      calculate();
    });

    resetBtn.addEventListener('click', function (e) {
      e.preventDefault();
      resetAll();
    });

    dlpInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        calculate();
      }
    });

    timerBtn.addEventListener('click', function(e) {
      e.preventDefault();
      startTimer();
    });
  </script>
</body>
</html>
